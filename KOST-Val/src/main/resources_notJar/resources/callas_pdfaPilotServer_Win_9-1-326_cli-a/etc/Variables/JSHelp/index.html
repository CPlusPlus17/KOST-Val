<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>Script Variables (JavaScript) Help </title>
    <style>
    	#toc {
    		float: right;
    		background: #eee;
    		margin-left: 2em;
    		padding-left: 1em;
    		padding-left: 0.5em;
    		padding-bottom: 1em;
    	}



        @font-face {
            font-family: 'SourceSansPro-Regular';
            src: url('./fonts/SourceSansPro-Regular.otf');
        }
        @font-face {
            font-family: 'SourceSansPro-Semibold';
            src: url('./fonts/SourceSansPro-Semibold.otf');
        }
        @font-face {
            font-family: 'SourceSansPro-Bold';
            src: url('./fonts/SourceSansPro-Bold.otf');
        }
        @font-face {
            font-family: 'SourceCodePro-Semibold';
            src: url('./fonts/SourceCodePro-Semibold.otf');
        }


		body {
            font-family: 'SourceSansPro-Regular';
		}
		#contents, #toc {	
			            max-width: 40em;
		}
		h1, h2, h3, h4, h5, h6 {
            font-family: 'SourceSansPro-Bold';
            color: #800;
            padding-top: 0.5em;
		}
		dt {
			font-family: 'SourceSansPro-Semibold';
		}

       /*     font-size: 9pt; 
       */
		code {
            font-family: 'SourceCodePro-Semibold';
            padding-left: 0.5em;
            padding-right: 0.5em;
            background-color: #ffb;
            color: #008;
            display: block;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
		}


    </style>

<script>

window.onload = function () {
    var toc = "";
    var level = 0;

    document.getElementById("contents").innerHTML =
        document.getElementById("contents").innerHTML.replace(
            /<h([\d])>([^<]+)<\/h([\d])>/gi,
            function (str, openLevel, titleText, closeLevel) {
                if (openLevel != closeLevel) {
                    return str;
                }

                if (openLevel > level) {
                    toc += (new Array(openLevel - level + 1)).join("<ul>");
                } else if (openLevel < level) {
                    toc += (new Array(level - openLevel + 1)).join("</ul>");
                }

                level = parseInt(openLevel);

                var anchor = titleText.replace(/ /g, "_");
                toc += "<li><a href=\"#" + anchor + "\">" + titleText
                    + "</a></li>";

                return "<h" + openLevel + "><a name=\"" + anchor + "\">"
                    + titleText + "</a></h" + closeLevel + ">";
            }
        );

    if (level) {
        toc += (new Array(level + 1)).join("</ul>");
    }

    document.getElementById("toc").innerHTML += toc;
};

</script>
</head>

<body>


<div id="toc">
	<h3>Table of Contents</h3>
</div>



<div id="contents">

<h1>Script Variables (JavaScript) Help</h1>	
	<h2>Where can JavaScript variables be used</h2>
		<p>
			Script variables can be used wherever Simple variables can be used: 
		</p>
		<ul>
			<li>In Checks or Fixups for text input fields, pop ups, checkboxes</li>
			<li>Severities of checks</li>
			<li>On/Off variables for Checks and Fixups</li>
		</ul>
		<p>
			It in addition is possible to use Script variables (but not Simple variables):	
		</p>
		<ul>
			<li>in a Profile as Profile script</li>
			<li>as a Process Plan step</li>
		</ul>				
		<p>
			In all places where Simple or Script variables can be used, the variable editor allows you to switch between both by means of a radio button. After a variable has been saved as Simple variable is is possible at any time to convert it into a Script variable here. However, it is not possible to convert a Script variable into a Simple variable. The reason is that this could potentially lead to problems when the same variable would be used in a place where only a Script variable is allowed.
		</p>
	<h2>Assigning a variable to a pdfToolbox Desktop control</h2>	
		<img src="./img/variable_popup.png" align="right" width="200px">
		<p>
			Wherever you see the variable icon <img src="./img/variable_icon.png" height="12pt"> in pdfToolbox Desktop you can click on it in order to assign a variable from a list of all variable keys that are defined in the current Library to the respective control; and you can create a new variable (either as Simple or as Script variable) and assign it; or you open the variable editor in order to modify a variable that has already been assigned.
		</p>
		<p>
			The list of variables in the pop up shows those variables that are already used in the current context (Profile, Check, Fixup) first and then all variables in the current Library. Script variable keys are followed by "(JS)" to indicate that these are JavaScript variables. After assigning a variable to a pdfToolbox Desktop control the variable key is displayed in the respective field (for text input fields or pop ups) or next to it (for checkboxes). Simple variables are displayed as &#60;Simple variable&#62;, Script variables as &#123;Script variable&#125;. 
		</p>
		<p>
			In order to un-assign a variable from a control you simply have to remove it from a text input field, to pick any other value in a pop up or to check/uncheck a checkbox.
		</p>
		<h3>Important differences to pdfToolbox versions earlier than version 9</h3>	
			<p>
				In pdfToolbox versions earlier than version 9 it was possible to copy a variable out of a pdfToolbox Desktop control and insert it into another control in order to assign it to both controls. This is not possible in pdfToolbox 9. You have to select the variable key from the variable pop up in the second or any further control.
			</p>
			<p>
				From pdfToolbox 9 on it is no more possible to make two variable occurrences using the same value simply by using the same variable name ("key"). Variables are only then the same if any additional occurrence is selected from the variable pop up in pdfToolbox Desktop. Otherwise two variables using the same key would be present which would at least be confusing when evaluated. 
			</p>
			<p>
				But: It would be difficult to resolve such conflicts when a Profile is imported as kfpx file, if the imported Profile uses the same variable key as a variable that is already present in the current Library. Therefore in such cases internally a variable merge process takes place that merges all variables that are defined in the very same way (key, default value and label) into a single variable.
			</p>
	<h2>Defining a variable in a script</h2>
		<p>
			If you want to define a variable in a script that is not used in any pdfToolbox Desktop control you may do so by writing at the top of your script:
			<code>app.requires("myvar")</code>
			myvar will then be created and show up in the Ask at Runtime dialogue or in --listvariables on command line. If you also want to set a default value and a display name (label) you can write:
			<code>app.requires("myvar",100,"Input a value for myvar")</code>
		</p>
	<h2>Setting a value for a Script variable</h2>
		<h3>Setting the value for the Script variable itself</h3>
			<p>
				A Script variable is populated with the value that is the result of the last statement in the script. So, if a Script variable would end with a statement like "pdfToolbox" it would have this string as its value, independent from what code has been executed beforehand. A return statement as in a JavaScript function is neither required nor would it have any effect.
			</p>	
		<h3>Setting the value for another Script variable with app.vars</h3>
			<p>
				It is possible to set a value for another variable in JavaScript code by means of an app.vars.&#60;variable key&#62; statement. The app.vars object is a pdfToolbox object that is available throughout the context (Process Plan, Profile, single Check, single Fixup) in which processing takes place. It allows you to store and retrieve variables within this context:</br>
				<code>app.vars.myvar = "pdfToolbox";</code></br>
				or:</br>
				<code>localvar = app.vars.myvar;</code></br>
				are valid statements. The first statement would create the variable "myvar" if not already present in app.vars. You may e.g. use app.vars to set a value for a variable on Profile level, which is then used in a Fixup in the Profile.
			</p>
			<p>
				In order to set a value for a Simple variable you can use app.vars.&#60;variable key&#62;. A list of all variables that are present in the current Library can be displayed in the Script editor by using [&#60;command&#62;-2].
			</p>
			<p>
				<b>Setting a value for a variable via JavaScript code should only take place on Profile level or as a "Variable" step of a Process Plan.</b> The reason is, that it is not defined in which order scripts on "lower levels" (Checks, Fixups, Severities, On/Off) are executed during runtime and therefore the result of e.g. one Fixup modifying a variable in another Fixup is undefined.
			</p>
	<h2>Using variables that are defined elsewhere</h2>
		<p>
			In order to use the value of a variable in JavaScript it can be accessed using the app.vars object with the key of the variable as already described above: app.vars.&#60;variable key&#62;. If the other variable is defined in a Script variable it has to be defined using app.vars there as well. If the other variable is a Simple variable it is always present in the app.vars object.
		</p>	
		<p>
			When retrieving variable values from app.vars it is important to know that all variables are stored there as strings. With simple value types you will most probably not even notice this, because a string is automatically converted if necessary and possible, e.g. into a number. However, if you are working with more complex variable types like with arrays or objects there will obviously be differences and you might have to work around this limitation.
		</p>
		<p>
			In complex profiles - actually when a Script variable is used in another Script variable - app.requires("&#60;variable key&#62;") has to be defined at the top of the referencing Script, in addition to the actual reference with app.vars. This is required in order to make sure that the referenced variable is evaluated before the referencing variable is calculated. So, it is good practice to at the top of each Script, list all variables which are not defined in the Script itself in app.requires entries.
		</p>
	<h2>Profile level scripts versus Check/Fixup level scripts</h2>
		<p>
			When you "design" a profile with JavaScript based calculations you have to decide whether you want to put the "intelligence" (the calculations) into Fixups and Checks that actually apply things to the PDF or into a Profile level script and set values for the variables that are then used in Fixups and Checks from there.
		</p>
		<p>
			Example: Downsample images in pdfToolbox usually requires to set up three fixups: for color images, grayscale images and for bitmap images. Each of the fixups has two input fields that you may want to make variable: The destination resolution and the minimum resolution for an image to be downsampled. Assume that you want to downsample color and grayscale images to the same resolution. Images should be downsampled if the original image resolution is 1.5 times as high as the destination resolution. Destination resolution for bitmap images should be 3 times as high as for color images, with the same relative minimum resolution (effectively 4.5 times color images' minimum resolution). You may now either make the destination resolution for color images a Simple variable, e.g. "dest_col_res" and make any of the other 5 variables a Script variable that uses dest_col_res and calculates the actual value. Or you set up a Profile level script, do all the calculations there and put the results into a bunch of Simple variables that you assign to each of the 6 variable input fields. (You will have to use app.vars in order to use variables throughout the Profile and in the second case you would use app.requires to define a variable for the destination image resolution in the Profile script.)
		</p>
		<p>
			Each of the two approaches has advantages:
		</p>
		<ul>
			<li>If you put the intelligence into Fixups and Checks it is easier to make it possible to use them as Single Fixups or Checks, independent from the Profile.</li>
			<li>If you put the intelligence into the Profile it is usually easier to see what a profile is actually doing and - even more important - to maintain it in the future.</li>
		</ul>
		<p>
		As a result and a rule of thumb it can be said, that it usually makes sense to put as much intelligence into the Profile level script. The more complex a Profile is, the more important is it to follow this approach.
		</p>	
	<h2>The Script editor</h2>
		<h3>User interface elements</h3>
			<p>
				When the variable editor is switched into Script "mode", you can find help with the info button on the upper right side of the Script input field. You will find more information if you click into the Script input field first. This gives you access to 
			</p>
			<ul>
				<li>
					a general help text (this text) [&#60;command&#62;-0], 
				</li>
				<li>
					a list of all pdfToolbox specific JavaScript objects and methods [&#60;command&#62;-1], 
				</li>
				<li>
					a list of all variables that are present in the current Library [&#60;command&#62;-2]
				</li>
				<li>
					useful code snippets [&#60;command&#62;-3].
				</li>
			</ul>
			<p>
				Above of the info button you see the value type of the pdfToolbox control to which the variable is currently assigned. This information is useful to know what type of result is expected from your script.
			</p>
			<img src="./img/variable_editor.png" width="800px">
		<h3>Show evaluation result</h3>
			<p>
				Below the text input field you can switch "Show evaluation results" on, which will help you to find out what the result of your JavaScript code is.
			</p>
			<p>
				It is important to remember that the result of JavaScript code used in a variable is the result of the last statement. The only exception is if invalid code is used, e.g. if a closing parenthesis is missing, in which case you will see a "Syntax error" with an explanation.
			</p>
			<p>
				In order to modify evaluation you can simulate how a JavaScript works different when used in a different "Context": You may either load a PDF (it will not open in pdfToolbox) to simulate how your script works on that PDF, e.g. when you are using the PDF path inside of your script. Or you switch between evaluation only for the script (in which case values that are set via other variables in your context are not evaluated) or evaluation within the context. All this information is helpful for debugging your scripts.
			</p>
			<p>
				A button at the right hand side indicates whether the result of the script works in the current pdfToolbox control. If the result is "pdfToolbox" and you are using the variable for a text input field you will see a green checkmark. However, if the variable is used for an integer number field you will see a red error cross. When you click on it you will read: ""pdfToolbox" cannot be converted to integer".
			</p>
			<p>
				The console window displays information that the JavaScript sends to it. It can be used with console.log.
			</p>
	<h2>Inspecting the variable structure in the Ask at Runtime dialogue in pdfToolbox Desktop</h2>
		<p>
			When you run a Process Plan, Profile, Check or Fixup in pdfToolbox Desktop that uses variables you will see the "Ask at Runtime" that allows for updating variable values. A checkbox at the bottom of the dialogue allows the user to "Inspect variables":
		</p>	
		<img src="./img/askatruntime_noinspect.png" assing="left" width="500px">
		<img src="./img/askatruntime_inspect.png" assing="right" width="500px">
			<p>
				If activated all calculated variables are displayed, not only those ones that allow for user input. A "Script" indicator shows values that cannot be modified in this dialogue because they are already calculated in the scripts. A button behind the Script variable fields indicates whether there is a type conflict, e.g. if the variable is used for a number field but the value is a string that cannot be converted to a number. In that case you will see a red cross. You may click on any of those red cross buttons in order to see details for the problem.
			</p>
			<p>
				The Ask at Runtime dialogue will only appear if a Profile/Check/Fixup has at least one variable that does not already have a value. If you want to enable the debug view in a Profile/Check/Fixup in which all variable values are set in scripts, you will have to add at least one additional variable, e.g. a Simple variable for that purpose.
			</p>
			<img src="./img/askatruntime_infobutton.png" width="400px" align="right">
			<p>
				Next to each variable you will see an info button. Clicking on this button allows for accessing information that is useful for debugging purposes. A list of all variables that are defined in the current context is displayed. (The content of the info window is actually the same for each of the info buttons, the only difference is that the control for the respective variable is opened by default.) Each of these variables is followed by the result that has been calculated for the respective variable. If you open the triangle for a variable you see an entry "Variables" that shows details about how that variable has been defined. Below are all contexts listed in which the respective variable is used.
			</p>
	<h2>pdfToolbox specific JavaScript objects and methods</h2>
		<p>
			pdfToolbox provides a number of objects and methods that can be accessed in JavaScript variables. This includes information about the PDF, like its name or file path, the metadata in the PDF and even results from a previous Check or Profile. <b>You can display a full list of all objects and methods by using [&#60;command&#62;-1] when in the Script editor</b>, select any of the entries and insert them into your script. So, <b>here are only a few very important ones </b>listed, to give you some "feeling" about what you can expect to be there.
		</p>
		<dl>
			<dt>app.vars.&#60;variable key&#62;</dt> <dd>Returns the value of a variable with the key &#60;variable key&#62;.</dd>
			<dt>app.doc.requires("&#60;variable key&#62;")</dt> <dd>Defines a variable that is required by the current script.</dd>
			<dt>app.doc.requires("&#60;variable key&#62;",&#60;default value&#62;,"&#60;label&#62;")</dt> <dd>Defines a variable, it's default value and the label.</br>		
			<dt>app.doc.documentFileName</dt> <dd>Returns the name of the PDF file.</dd>
			<dt>app.doc.path</dt> <dd>Returns the file path of the PDF.</dd>
			<dt>app.doc.numPages</dt> <dd>Returns the number of pages in the PDF.</dd>
			<dt>app.doc.getPageBox(pageBox,pageNumber, precision)</dt> <dd>Returns the coordinates of "Trim", "Bleed", "Crop" or "Media" box of the specified page with the number of float units as specified by precision.</dd>
			<dt>app.doc.xmp.getProperty(ns,property)</dt> <dd>Returns the value a property in the XMP metadata in the PDF.</dd>
			<dt>app.doc.result.checks[i].pageNumbers</dt> <dd>Returns an array of page numbers for which the check with the number 'i' had generated a hit in the last Profile, Check, Fixup that has been applied to the PDF. This can be used in a Process Plan to determine which pages have a certain quality and to then apply a correction or modification only to those pages.</dd>
			<dt>app.doc.result.checks[i].id</dt> <dd>Returns a unique ID for a check.</dd>
			<dt>And...</dt><dd>Again: These are just examples. Just use [&#60;command&#62;-1] to see a complete overview.</dd>
		</dl>
</div>
</body>
</html>
